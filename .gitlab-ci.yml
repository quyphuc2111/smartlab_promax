stages:
  - build
  - release

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  RUSTUP_HOME: ${CI_PROJECT_DIR}/.rustup

# Cache để tăng tốc build
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cargo/
    - backend/target/
    - src-tauri/target/
    - node_modules/

# Build Windows App
build-windows:
  stage: build
  tags:
    - windows
  before_script:
    - choco install nodejs-lts -y --no-progress
    - choco install rust -y --no-progress
    - refreshenv
    - node --version
    - npm --version
    - rustc --version
    - cargo --version
  script:
    # Install frontend dependencies
    - npm ci
    
    # Build backend
    - cd backend
    - cargo build --release
    - cd ..
    
    # Copy backend to resources
    - mkdir -p src-tauri/resources
    - cp backend/target/release/ip_scanner_api.exe src-tauri/resources/
    
    # Build Tauri app
    - npm run tauri build
  artifacts:
    name: "smartlab-windows-${CI_COMMIT_SHORT_SHA}"
    paths:
      - src-tauri/target/release/bundle/msi/*.msi
      - src-tauri/target/release/bundle/nsis/*.exe
      - backend/target/release/ip_scanner_api.exe
    expire_in: 30 days
  only:
    - main
    - develop
    - tags

# Build trên Linux Runner (nếu có)
build-linux:
  stage: build
  image: rust:latest
  tags:
    - docker
  before_script:
    # Install Node.js
    - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    - apt-get install -y nodejs
    
    # Install Tauri dependencies
    - apt-get update
    - apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev
  script:
    - npm ci
    
    # Build backend
    - cd backend
    - cargo build --release
    - cd ..
    
    # Build Tauri (Linux)
    - npm run tauri build
  artifacts:
    name: "smartlab-linux-${CI_COMMIT_SHORT_SHA}"
    paths:
      - src-tauri/target/release/bundle/deb/*.deb
      - src-tauri/target/release/bundle/appimage/*.AppImage
      - backend/target/release/ip_scanner_api
    expire_in: 30 days
  only:
    - main
    - tags
  allow_failure: true

# Release job - tạo release khi push tag
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  tags:
    - docker
  script:
    - echo "Creating release for ${CI_COMMIT_TAG}"
  release:
    tag_name: ${CI_COMMIT_TAG}
    name: "SmartLab ${CI_COMMIT_TAG}"
    description: |
      ## SmartLab - Hệ thống quản lý phòng máy thông minh
      
      ### Tính năng:
      - Quản lý phòng máy và thiết bị
      - Điều khiển máy tính từ xa
      - Quản lý ca thực hành
      - Hỗ trợ giảng dạy trực tuyến
      
      ### Cài đặt:
      - Tải file installer bên dưới
      - Chạy installer và làm theo hướng dẫn
    assets:
      links:
        - name: "Windows Installer (MSI)"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/src-tauri/target/release/bundle/msi/SmartLab_0.1.0_x64_en-US.msi?job=build-windows"
        - name: "Windows Installer (EXE)"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/src-tauri/target/release/bundle/nsis/SmartLab_0.1.0_x64-setup.exe?job=build-windows"
  only:
    - tags
  needs:
    - job: build-windows
      artifacts: true
